{% extends "base.html" %}

{% block outdated %}
<div class="outdated-text-wrapper">
    <div>
        <span>You're not viewing the latest version.</span>
        <a href="{{ '../' ~ base_url }}">
            <strong>Click here to go to latest.</strong>
        </a>
    </div>
    <button aria-label="Dismiss this warning for one month">
        {% include ".icons/material/close.svg" %}
    </button>
</div>

{% endblock %}

{% block scripts %}

{{ super() }}

<script>
    const DEV_PATHS = ['dev', 'preview']
    const outdatedEl = document.querySelector('[data-md-component="outdated"]')
    const path = window.location.pathname
    let isDevPath = false

    for (const dev_path of DEV_PATHS) {
        if (path.startsWith("/" + dev_path)) {
            isDevPath = true
            break
        }
    }

    if (isDevPath) {
        document.body.classList.add('dev-mode')
        outdatedEl.querySelector('span').textContent = `You are viewing the docs for an unreleased version of zcx.`
        outdatedEl.querySelector('strong').textContent = `Click here to see the latest stable version.`
    }

    outdatedEl.querySelector('button').addEventListener('click', () => {
        if (isDevPath) {
            localStorage.setItem('devModeWarningDismissed', JSON.stringify(new Date()))
            umami.track('dismiss-warning-dev')
        } else {
            localStorage.setItem('outdatedWarningDismissed', JSON.stringify(new Date()))
            umami.track('dismiss-warning-outdated')
        }

        outdatedEl.remove()
    })

    let relevantWarningDate;
    if (isDevPath && localStorage.getItem('devModeWarningDismissed') !== null) {
        relevantWarningDate = localStorage.getItem('devModeWarningDismissed')
    } else {
        relevantWarningDate = localStorage.getItem('outdatedWarningDismissed')
    }

    if (relevantWarningDate) {
        const dismissedDate = new Date(JSON.parse(relevantWarningDate))
        const daysSinceDismissed = (new Date() - dismissedDate) / (1000 * 60 * 60 * 24)

        if (daysSinceDismissed < 28) {
            outdatedEl.remove()
        }
    }


    const isDigit = (char) => {
        return /^\d$/.test(char)
    }

    const processVersionElements = () => {
        const versionElements = []
        const versionChooserButton = document.querySelector('.md-version__current')
        if (versionChooserButton && isDigit(versionChooserButton.textContent[0])) {
            versionElements.push(versionChooserButton)
        }
        const versionListItems = document.querySelectorAll('.md-version__list li')
        for (const versionLi of versionListItems) {
            if (isDigit(versionLi.textContent[0])) {
                versionElements.push(versionLi)
            }
        }

        for (const versionElement of versionElements) {
            versionElement.classList.add('version-number')
        }

        return versionElements.length > 0
    }

    if (!processVersionElements()) {
        const observer = new MutationObserver(() => {
            if (processVersionElements()) {
                observer.disconnect()
            }
        })

        observer.observe(document.body, {
            childList: true,
            subtree: true
        })

        setTimeout(() => observer.disconnect(), 5000)
    }

</script>

{% endblock %}